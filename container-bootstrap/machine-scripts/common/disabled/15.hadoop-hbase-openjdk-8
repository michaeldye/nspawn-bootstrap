#!/bin/bash -e

function setup_env() {
  env_file=$1; shift
  java_home=$1; shift

  # N.B. there's a lot more you can do with hadoop-env.sh than this...
  mkdir -p $(dirname $env file)
  cat >> $env_file <<EOF
export JAVA_HOME=$java_home
EOF

  chmod +x $env_file
  echo "$env_file"
}

function cp_cfg() {
  src_dir=$1; shift
  dst_dir=$1; shift

  cp -vfa $src_dir $dst_dir
  chown -R admin:admin $dst_dir
}

HOST=$1; shift
DOMAIN=$1; shift
_=$1; shift
COMMON_DIR=$1; shift

source $COMMON_DIR/scripts-include-pkg || exit 6

FQDN="$HOST.$DOMAIN"

echo "Executing setup of hadoop hdfs in $FQDN"

[[ -z "$JDK_PKG" ]] && (echo "JDK_PKG envvar unset, cannot install" >&2) && exit 1
apt-get install -y openjdk-8-jdk-headless curl netcat-openbsd

# TODO: deduplicate
[[ -z "$HADOOP_VER" ]] && (echo "HADOOP envvar unset, cannot install" >&2) && exit 1
tar zxf /setup/hadoop-$HADOOP_VER.tar.gz -C /usr --transform="s,hadoop-${HADOOP_VER},hadoop," || exit 2

[[ -z "$HBASE_VER" ]] && (echo "HBASE envvar unset, cannot install" >&2) && exit 1
tar zxf /setup/hbase-$HBASE_VER-bin.tar.gz -C /usr --transform="s,hbase-${HBASE_VER},hbase," || exit 2

chown -R admin:admin /usr/{hadoop,hbase}

sed -i '/^export PATH=/d' ~admin/.bash_profile

export HADOOP_HOME=/usr/hadoop
export HBASE_HOME=/usr/hbase
HBASE_MANAGES_ZK=no

# this is usually in /tmp (see https://github.com/apache/hbase/blob/master/bin/hbase-daemon.sh) but we'd like it to be named the same thing on all systems regardless of cmd
HBASE_ZNODE_FILE=$HBASE_HOME/znode

# used by systemd unit files too (TODO: consider using a systemd environment generator instead)
cat >> ~admin/hadoop-hbase.env <<EOF
JAVA_HOME=$JDK_JAVA_HOME
HBASE_HOME=$HBASE_HOME
HADOOP_HOME=$HADOOP_HOME
HADOOP_COMMON_HOME=$HADOOP_HOME
HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop
HADOOP_YARN_HOME=$HADOOP_HOME
HADOOP_MAPRED_HOME=$HADOOP_HOME
HADOOP_HDFS_HOME=$HADOOP_HOME
EOF

cat >> ~admin/.bash_profile <<EOF
set -a
source /home/admin/hadoop-hbase.env
set +a

export PATH=\$HBASE_HOME/bin:\$HADOOP_HOME/bin:\$JAVA_HOME/bin:$PATH
EOF

setup_env $HADOOP_HOME/etc/hadoop/hadoop-env.sh $JDK_JAVA_HOME
cp_cfg $COMMON_DIR/fs/usr/hadoop /usr/

created=$(setup_env $HBASE_HOME/conf/hbase-env.sh $JDK_JAVA_HOME)
echo "export HBASE_MANAGES_ZK=$HBASE_MANAGES_ZK" >> $created
echo "export HBASE_ZNODE_FILE=$HBASE_ZNODE_FILE" >> $created

touch $HBASE_ZNODE_FILE
cp_cfg $COMMON_DIR/fs/usr/hbase /usr/

# do overwrites and stuff
bash -x $COMMON_DIR/util/hadoop-lib-overwrite.bash

exit 0
